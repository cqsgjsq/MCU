**************************************************************绝对不能因为女色而拖更**************************************************************

--------------------------2020.3.13
for input:
low = 0.3 * VDO
high = 0.7 * VDD
hysteresis = 0.1*VDD
--------------------------2020.3.14
Q：低功耗问题（进入低功耗后，暗电流差距1mA多）
A：1.检查进入低功耗流程是否有误？ 2.根据外部电路配置IO口，普通IO口配置为输出低电平
怀疑对象：
低功耗期间时钟用的是LSI，HSE没有关闭？
实验结果：MCU不能选着LSI用做Fmaster，因为option byte默认禁止LSI当作fmaster!

Do：AMU或者halt模式期间给芯片加热，低功耗会下降很多，随着温度上升，低功耗会增大（AMU状态下，LSI受温度影响较大）
1.给功耗差别大PCB交换芯片，看是贴片的问题还是芯片的问题？
2.检查IO口是否真的如预期配置，such as:有些引脚只有OD
3.检查各个外设所消耗电流
4.进入低功耗前检查寄存器value是否如预期？
5.去掉外部电路，check芯片自身功耗
6.理论功耗+外部电路，理论与实际差别是否可接受
7.是否开启WD？

最终原因：芯片内部还有很多IO口,我们只拉低外部能看到的引脚，其实内部还有很多引脚，我们也需要拉低内部引脚，使其处于最低功耗

其实datasheet相关PIN图下面一直都有提示，不过自己确实没看数据手册，在开发前，应该先看MCU基本信息的，有没什么特别注意的事项，如果当初开发前了解了相关事项，就不会浪费起码好几天的开发时间和10块开发板了！

2020.3.16
有时候不能从低功耗唤醒？
我第一反应居然是软件问题？
正确的工程师，应该是先排查电源是否有问题，然后排查MCU的引脚硬件电路，看MCU外部电路是否正常，然后才应该开始排查软件问题，MDZZ。。。

2020.3.17
读取IO口Level时，要配置input float状态，不然会影响读取的IO值！如果配置为输出低电平，MCU内部会有个下拉电阻，该引脚连接外部电路，如果外部电路输出高电平，经过下拉电阻，此时IO引脚读取不准确！

2020.3.24
关于输入捕获，其实很简单，就是连续读取2次PWM的上升沿，TIM计数器会把此时的CNT Value给相应寄存器，当正在处理第一次上升沿的时候（程序还没读取结束），此时第二次上升沿来的时候，此时有个TIMx—>SR2有个相应的OF（over flag），在第一个上升沿后，程序应该while（1==TIMx->SR2）;
为了减少计算，ST有个复位触发模式，在上一个上升沿，CNT变为“0”，这样第二个上升沿的CNT Value就是其PWM周期！
计算占空比的时候，可以用另一个通道来capture它的下降沿，和复位触发模式搭配，这样得到的值就是“1”的占用时间
如果第一个和第二个上升沿间隔超过了TIMx一个最大计数值，可以通过分频的形式，降低计数频率，来延长时间！

对于一些库函数的操作，在编译中，有些警告不能忽略，比如TIMx的PWM输出，如果相关.c文件没有包括声明，就使用该函数，最后烧录进flash，是没有PWM输出的！但是自己写的函数，没有声明，该函数是可以运行的，所以怀疑是IDE工具配置选项的问题！

2020.3.25
关于捕获是用中断还是等待？
使用中断将耗费CPU资源，使用循环等待，就会影响其他模块的执行，而且程序还有卡死的风险！
关于定时器模块的PWM捕获，不能在中断打断点，否则得到的value有点异常，可以利用数组的形式，打印出来，对于上升沿和下降沿的捕获，确保先捕获上升沿，再捕获下降沿，要保持逻辑的连贯性，在上升沿中赋值一个变量step++，然后捕获下降沿的前提条件是step==1，同理捕获完成后step++，又在上升沿判断

2020.3.26
关于芯片自身的低功耗，主要集中在IO口，和外部电路的电流，
不能对所有的IO口都输出为低，demo:CAN module ，T/RX要设置为开漏，开漏比输出低电平更加省电，原因是CAN驱动芯片的影响；

2020.3.27
操作eeprom的时候，要注意MCU的电压
MCU operating voltage（execute code） 2.6V~5.5V  
MCU operating voltage（all mode ,execute write erase） 2.6V~5.5V  
标准programming（1byte，4byte 128byte）time 	Max == 6.6MS
erase Time for 1block（128 bytes）               Max == 3.3Ms
MCU execute code逻辑判断的时候，要特别注意eeprom的操作时间 很重要！

2020.3.28
IAR从debug版本到release版本，其实debug版本里面有很多系统自己添加的仿真代码，所谓的软件仿真调试，就是在程序中添加一些代码，设置一些陷阱，然后在这里打断点，所以debug版本编译出来的烧录文件比release版本大很多
关于release报错的问题，重新设置一下Options...选项的配置，比如用的是什么芯片型号，“C/C++Compiler"的"Preprocessor"里面要重新包含一下头文件路径。

2020.5.7
问题:
1.烧录程序完成。正常电压12V上电仿真工作，缓慢下电压到6.5V CAN通讯关闭，继续下电压到6.3V CAN通讯将恢复，再继续下电到5V左右CAN通讯再次关闭？
（和软件硬件沟通后判定为参考电压不准导致CAN异常恢复）
（一）参考电压不准，导致读取的AD不准，所以6.5V关闭了CAN，在6.3V的时候此时参考电压不是5V，所以此时MCU认为AD值已经达到了CAN开启的A的阀值
（二）也是由于参考电压的原因，在6.5V正常关断CAN，然后再下降到6.3V，此时读取的IO口电平，有可能是高，也有可能是低，所以导致MCU频繁进出低功耗，由于在初始化的时候，CAN默认是开启的，所以在6.3V，CAN依然可以通讯
（三）同时存在以上2种原因
Debug:1.上电初始化默认是欠压模式关闭CAN，满足电压条件后才发送CAN
2.kl15外接高电压，此时可以超级简单判断是频繁进出低功耗问题还是算法问题。。。。妈的，怎么才想到
3.更改硬件，提高KL15的电阻，增加分压比例，此时KL15的IO口不会有处于那种undefined状态！

终极原因:还是频繁进出低功耗原因。。。

2.0V缓慢升起电压，6.4V左右CAN 短暂恢复通讯后关闭，继续升高电压到7V左右CAN通讯恢复
参考电压原因可能导致算法问题或者进出低功耗                                              
3.3V左右缓慢升起电压，6.4V左右CAN 恢复通讯，继续升高电压不会有中断的现象。
MCU工作电压为(2.6~5.5)V，此时由于参考电压原因，KL5一直是ON，所以CAN一直没关闭，未验证
以上主要是电压的阀值，IO口处于undefined状态！

要确定MCU处于那个状态，可以在MCU种输出PWM波形或者高低电平，调节高低电平，或者不同占空比！！！！！！！！！！！！！！
还是推荐PWM波形，因为MCU不处于工作状态，没配置IO口，肯定不会输出PW波形，
不同MCU的IO口默认不同，powerPC就是weak pull-up，所以很难确定！


2020.5.18
问题:7WDCT运行过程中，CAN偶尔发送错误帧
D0:观测RSTN引脚，发现每次1S多的时间，RSTN引脚拉低了，SBC进入了fail-safe模式
Q:是CAN模块坏了还是SBC坏了或者MCU复位/进出低功耗？
A:每次1S多的时间复位了，跟SBC喂狗时间是1S的时间，有点想象，
1.是否是软件在某个函数停留太久了，导致SBC没有喂狗？                     No，Mcu自身也有看门狗，而且该WD时间比SBC还短
2.是否是SBC的CAN模块坏了                                           No：如果坏了，不可能时好时坏
3.SBC每次都能复位，说明SBC大概率没坏，那么根据现有的现象说明没有成功给SBC喂狗，喂狗的本质是SPI通信，该系列有2个部位会用到SPI，是否另一个SPI器件占空了SPI通道，导致没有给SBC喂狗？
用示波器观测SPI的3个数据线，发送MCU的SDO大部分为0V？MLX坏掉了影响了SBC？
从功能安全角度来讲，2个器件不应该共用一个SPI通道


问题:KL30&&KL15上电出现错误帧？为什么CN210M没有呢？ 真的奇怪哦
CAN自身有载波侦听，边发送边检测，应该是检测到发送的报文错误了，就发送错误帧了。。。
Do:
1.是否是KL30上电时进出了低功耗或者电压判断 导致出现了错误帧？  软件上取消对电压/低功耗的判断
2.CAN的IO口没有配置好，就发送报文了？

2020.5.28
测量chip最低工作电压
测试方法:MCU在上电后初始化TIMX，配置PWM输出，然后调节电压，测量chip最低VCC工作电压
Do:
1.RSTN引脚在低电压时，会有个欠压复位，拉低后，又拉高
2.VCC电压在2.8V以上，有输出PWM波形
3.VCC电压在2.7V～2.8V范围内，由于VCC低压监测，所以RSTN引脚一直复位，没有PWM输出波形，
4.VCC电压大于1V时，RSTN引脚一直为0V，小于1V时，RSTN引脚电压不为0V，所以该区间电流有点大



2020.9.25---------------------------------------分析工具的重要性
这几天调节I2C，软件上没有问题，调节I2C的时候，start的波形有，但是8位数据的波形确实是抓不到，我设置的I2C是400KHZ，讲道理500K的CAN波形都能捕获，400K的波形一次都没捕捉到，
换了2块PCB，发现都没有波形，软件也没有任何问题，最后交给FAE，同样的硬件和软件，他们用的逻辑分析仪，可以准确捕获到，但很奇怪，我让FAE用示波器去探测，结果也跟我这边测试结果一样，
最后他们找了一个超强的示波器，可以监测到波形。
其实一个很棒的监测工具也还是很有必要的，特别是调试通信协议时，用逻辑分析器可能会更好吧～ 有时并不是出错了，也可能是测试工具不够好，其实也就是不够贵，对于一个好的工程师来说
示波器，逻辑分析仪，万用表这3大件还是非常重要的，好就是贵，贵就是好！


2020.9.26
说好的每周更新技术博客，因为个人感情原因，没有及时更新，下次一定，下次一定！
周末因为I2C的问题跟ST的FAE聊了很多，他在一家公司当FAE10年了，我问客户一般都是些什么问题，他毫不犹豫的说大部分问题都是电源引起的，很多都是前端电源引起的，他给我列举了2个demo:
1.AD采样误差允许在千分之5，但实际读出来总是大于这个偏差值，客户软件上也滤波了，硬件上各种措施也都做了，但结果总是不行，最后从源头排查起，发现是电源的原因
2.客户的IO配置的上升沿中断，但是下降沿也会触发中断，当然肯定是排除了软件的问题，最重要的现象是用示波器也捕捉不到（上一篇讲示波器，示波器也很重要）,最后发现也是电源引起的，也是因为电源影响了IO口！
其实工程师都知道前端电源很重要，只是真的很容易忽视，很多问题其实真的不是芯片自身问题，不过真的很难发现。

**************************************************************绝对不能因为女色而拖更**************************************************************


2020.10.8
今天国庆最后一天，差点又忘记了更新。。。
这次讲讲我调试I2C的过程，本人很赖，最怕调试驱动部分了，各种寄存器操作麻烦的很，但工作后嘛，都是你做，除了自己调试还能怎么办嘛 QAQ
调试前I2C的理论我感觉我掌握的还可以，拿到PCB后，第一件事是看电压，5V转3.3V是否OK，SCI/SDA是否能正确跳变，嗯，，，，
观察示波器波形，I2C的start波形是有的，但是数据波形没有，FAE说是示波器的原因，我她妈居然信了。。
说到这里就要说下stm8af的官方I2C底层驱动函数了，写数据位，虽然是7位的数据，但是尼玛底层驱动又没说清楚，奇数的地址可以发送，有波形，偶数的地址，没有波形，
查看发送官方函数，MD原来有个宏函数，实参不能通过，所以一直在死循环等待。。。参数是7位的地址，所以实参要左移一位，然后搭配第0位的读/写 位！
还有就是如果用官方驱动，发送start后，妈的，有个等待位检测，检测是否start成功发送，但是这个检测时间太长了，我也没找到I2C对时序的要求，所以几句没管，但实际上，我用的maXtouch对这个时序是有要求的
然后我去掉这个等待检测，采用nop()函数， 等待时间变短了，然后终于收到从机的应答了！！！


2020.10.9
在做低温实验时，电机无法转动，根据报文反馈，电机转动超时/H桥故障，通过示波器检测，电机超时是因为没有转到目标位置，2S的时间内，如果堵转了，电机应该是最大PWM输出，提高到最大扭矩
在实验室里，示波器太容易收到干扰了，工业设备真的应该抗干扰，所以汽车级别做EMC是很有必要的！
为什么-40摄氏度，电机会发生转不动的情况？常温下和高温下都可以，低温为什么不行？
不知道是否因为电机受低温条件影响？

2020.12.23
A06—7WDCT 项目替换hall传感器，同样的SPI驱动，更换后SPI驱动都不正常了？
去掉该holl芯片，SBC正常，SPI通信正常，加上hall后，整个SPI都异常
so 肯定是该hall芯片异常！！！！但是测试了hall芯片的IO口，都是正常的
最后发现SPI电压有2.5V的情况。。。。然后发现PCB焊盘 oll芯片没接GND。。。
出现问题时，一定要看芯片是否工作在正常条件下！



MLX90363 发送get command后，第二次nop command 没有接受到Angel信息而是nop的数据？？？